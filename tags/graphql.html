<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    
    <title>eformat.me - graphql</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="eformat.me : graphql">
    <meta property="og:title" content="eformat.me - graphql" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://blog.eformat.me/img/eformat.me.jpg" />
    <meta property="og:url" content="https://blog.eformat.me/tags/graphql.html" />
    <meta property="og:description" content="eformat.me : graphql" />
    <meta property="og:locale" content="en_GB" />
    <meta property="og:site_name" content="eformat.me" />

    <!-- Le styles -->
    <link href="../css/lightbox.css" rel="stylesheet">
    <link href="../css/yeti/bootstrap.min.css" rel="stylesheet">
    <link href="../css/base.css" rel="stylesheet">
    <link href="../css/asciidoctor.css" rel="stylesheet">
    <!-- link href="/css/bootstrap-theme.min.css" rel="stylesheet" -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../favicon.ico">

    <!-- WebAnalytics -->
    <script defer data-domain="blog.eformat.me" src="https://plausible.apps.sno.eformat.me/js/script.js"></script>
  </head>
  <body>
    <div id="wrap">

	
	      <!-- Fixed navbar -->
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container-fluid">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-menu">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../index.html">eformat.me</a>
          </div>
          <div class="collapse navbar-collapse" id="navbar-menu">
            <ul class="nav navbar-nav">
              <li><a href="https://github.com/eformat" target="github:eformat">Github</a></li>
              <li><a href="../archive.html">Archives</a></li>
              <li><a href="../feeds/posts/default.xml">Flux RSS</a></li>
              <li><a href="https://plausible.apps.sno.eformat.me/blog.eformat.me" target="eformat:analytics">Analytics</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
      <div class="container">


	<div class="page-header">
            <div class="row">
                <div class="col-xs-4 col-md-2"><img src="../img/eformat.me.jpg"></div>
                <div class="col-xs-12 col-md-8"><h1>Tag: graphql</h1></div>
            </div>
	</div>

    <div class="row">

    <div class="col-sm-8">
        
            
                <a href="../2023/06/graphql-federation-quarkus.html"><h1>GraphQL Federation with Quarkus</h1></a>
                <p>16 June 2023</p>

                <p>Tags :
                <a href="quarkus.html">quarkus</a>, <a href="graphql.html">graphql</a>, <a href="apollo.html">apollo</a>, <a href="api.html">api</a>, <a href="teams.html">teams</a>
                </p>

                <!--a href="https://twitter.com/share" class="twitter-share-button" data-url="http://www.eformat.me/2023/06/graphql-federation-quarkus.html" data-text="GraphQL Federation with Quarkus" data-via="eformat" data-lang="en">Tweeter</a-->
                <!--script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script-->
                <div class="g-plusone" data-size="medium" data-href="http://www.eformat.me/2023/06/graphql-federation-quarkus.html"></div>

                <p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>A canonical example using Quarkus GraphQL Federation and the Apollo Gateway server.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_new_age_of_apis">New Age of API&#8217;s</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For some time now I have been following and using graphql as an API mechanism. If you have not heard of it, there are many <a href="https://www.apollographql.com/docs/intro/benefits">great resources</a> that talk about the benefits. Another <a href="https://graphql.org/learn/">great learning site is here</a>. For me, some obvious benefits of GraphQL include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>eliminates over-fetching of data from an API</p>
</li>
<li>
<p>code a graphql API that can easily change without having to modify all the client code</p>
</li>
<li>
<p>you don&#8217;t end up with hundreds of REST API&#8217;s for every single use case that come up</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In particular though - the composable nature of <strong>Federated</strong> graphql schemas is what catches my eye. Some early adopters like Netflix have blogged
about their engineering efforts in this area.</p>
</div>
<div class="paragraph">
<p>In particular checkout Netflix&#8217;s <a href="https://netflixtechblog.com/how-netflix-content-engineering-makes-a-federated-graph-searchable-5c0c1c7d7eaf"><strong>Studio Search</strong></a>
and <a href="https://netflixtechblog.com/data-movement-in-netflix-studio-via-data-mesh-3fddcceb1059"><strong>DataMesh</strong></a> blogs</p>
</div>
<div id="lightbox"></div>
<div class="imageblock id="netflix-studio-search">
  <img src="/2023/06/netflix-studio-search.png" class="zoom">
</div>
<div class="paragraph">
<p>By using a Federated Graph with graphql, different departments within the company can control and contribute independently the API&#8217;s that compose StudioSearch.</p>
</div>
<div class="paragraph">
<p>For me, this also fits in with a <strong>Team Topology</strong> view of the world - where individual stream aligned business teams can control their bits of the graph, whilst contributing to the whole fairly autonomously.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_issues_of_code">Issues of Code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Graphql was born in a nodejs ecosystem. But of course we ‚ù§ Java, and in particular, Quarkus has a <a href="https://quarkus.io/guides/smallrye-graphql"> smallrye graphqlÔ∏è implementation</a>.</p>
</div>
<div class="paragraph">
<p>There has been a long-running <a href="https://github.com/smallrye/smallrye-graphql/issues/521">RFE</a> for adding GraphQL Federation to Quarkus. I would say in general things are looking pretty good these days with the addition of federation into the underlying <a href="https://smallrye.io/smallrye-graphql/2.2.1/federation/">smallrye implementation</a>.</p>
</div>
<div class="paragraph">
<p>The other day, I was following this <a href="https://github.com/quarkusio/quarkus/issues/30180">bug</a> around resolving entities and was thinking to myself "this should work OK now!!" - so I went ahead and played around with the code. What resulted was a nice simple working
example of graphql federation.</p>
</div>
<div id="lightbox"></div>
<div class="imageblock id="federated-subgraph">
  <img src="/2023/06/federated-subgraph.png" class="zoom">
</div>
<div class="paragraph">
<p>In the picture of Apollo&#8217;s Explorer - the Product{id, name} are sourced from the Product subgraph, and the Product{review} from the Review subgraph.</p>
</div>
<div class="paragraph">
<p>ü§† The <a href="https://github.com/eformat/quarkus-graphql-issue">Source Code is HERE</a> so you can follow along. ü§†</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_example_in_detail">The Example in Detail</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let me explain it a bit more in detail. There are three pieces to the simple architecture - a gateway component (apollo server), and two Quarkus graphql API&#8217;s (Product, Review).</p>
</div>
<div class="paragraph">
<p>You can run the two Quarkus graphql API&#8217;s using maven, and for any one of them, browse to the Quarkus Developer UI by hitting the 'd' key in the terminal. For example:</p>
</div>
<div id="lightbox"></div>
<div class="imageblock id="quarkus-dev-ui">
  <img src="/2023/06/quarkus-dev-ui.png" class="zoom">
</div>
<div class="paragraph">
<p>Use the Smallrye GraphQL panel to browse the individual schema, and to run individual queries using GrapQi against the single API e.g. for the Product api</p>
</div>
<div id="lightbox"></div>
<div class="imageblock id="graphql-productById">
  <img src="/2023/06/graphql-productById.png" class="zoom">
</div>
<div class="paragraph">
<p>we can run ProductByID and see the result for the fields we desire.</p>
</div>
<div class="paragraph">
<p>Now, in the Review service, we use a Federated Entity <a href="https://www.apollographql.com/docs/federation/entities">that you can read about here</a> to extend the Product with a Review.</p>
</div>
<div class="paragraph">
<p>The key bit of Java code is the annotations that make this happen in the Review module&#8217;s Product domain model class i.e. <code>@Extends</code> and <code>@Key</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Extends
@Key(fields = "id")
public class Product {
    private Review review;
    // getters and setters not shown
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this way, we are extending the Product from the Product API with a Review.</p>
</div>
<div class="paragraph">
<p>We can query the individual graphql schemas in the DevUI or from the command line using curl.</p>
</div>
<div class="paragraph">
<p>Product API</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="bash">$ curl http://localhost:8081/graphql/schema.graphql

union _Entity = Product

type Product @key(fields : "id") {
  id: ID
  name: String
}

"Query root"
type Query {
  _entities(representations: [_Any!]!): [_Entity]!
  _service: _Service!
  "All Products"
  allProducts: [Product]
  "Find product by ID"
  productById(id: String): Product @provides(fields : "id")
}

type _Service {
  sdl: String!
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Review API</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="bash">$ curl http://localhost:8082/graphql/schema.graphql

union _Entity = Product | Review

type Product @extends @key(fields : "id") {
  id: ID
  review: Review
}

"Query root"
type Query {
  _entities(representations: [_Any!]!): [_Entity]!
  _service: _Service!
  "Find product by ID"
  productById(id: String): Product
  "Find review by ID"
  reviewById(id: String): Review
}

type Review @key(fields : "id") {
  id: ID
  product: Product
  rating: Int
  text: String
}

type _Service {
  sdl: String!
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can see that the Product {id review} is provided by the Review API whilst the Product {id name} is provided by the Product API. You can also Query for Reviews and Products independently.</p>
</div>
<div class="paragraph">
<p>I have ommitted all the scalars and directives in the schema output above that are generated by setting these application properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="bash">quarkus.smallrye-graphql.schema-include-scalars=true
quarkus.smallrye-graphql.schema-include-directives=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>These are required by the gateway when it <strong>introspects</strong> the grapql schema to compose the one <strong>Supergraph</strong>.</p>
</div>
<div class="paragraph">
<p>Now to the gateway piece, which is run using apollo nodejs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="bash">gateway$ npm run start

&gt; start
&gt; nodemon gateway.js

[nodemon] 2.0.22
[nodemon] to restart at any time, enter `rs`
[nodemon] watching path(s): *.*
[nodemon] watching extensions: js,mjs,json
[nodemon] starting `node gateway.js`
üöÄ  Server ready at: http://localhost:4000/</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you browse to the apollo endpoint, it will take you to the Sandbox which is very similar to the Quarkus GraphQi interface (the sandbox connects a websocket to your localhost:4000 port eventhough it appears on a cloud hosted url). It shows a nice schema view for the supergraph:</p>
</div>
<div id="lightbox"></div>
<div class="imageblock id="graphql-productById">
  <img src="/2023/06/apollo-fed-schema.png" class="zoom">
</div>
<div class="paragraph">
<p>You can also query this using curl which is harder and a bit uglier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="bash">$ curl -s -X POST http://localhost:4000/graphql -H "Content-Type: application/json" --data-binary '{"query":"{\n\t__schema{\n queryType {\n fields{\n name\n }\n }\n }\n}"}' | jq .
{
  "data": {
    "__schema": {
      "queryType": {
        "fields": [
          {
            "name": "allProducts"
          },
          {
            "name": "productById"
          },
          {
            "name": "reviewById"
          }
        ]
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The important bit is this is the federated Supergraph .. so when we query for Product - we can ask for the Product {id name review} fields and the gateway resolves the entities for us, yay !!</p>
</div>
<div class="paragraph">
<p>The one little hack required for the Apollo code to work with Quarkus, it is documented in the README. Apollo does not support the newish <code>application/graphql+json</code> Mime Type yet despite PR&#8217;s ;) <a href="https://github.com/apollographql/federation/pull/1767">including one from me</a>!</p>
</div>
<div class="paragraph">
<p>Hope you Enjoy! there is a wealth of fun stuff to code with using graphql (go lookup Mutations next!) üëæüëæüëæ</p>
</div>
</div>
</div></p>
                <p><a href="2023/06/graphql-federation-quarkus.html#disqus_thread">Commentaires</a></p>
            

        

    </div>

    <div class="col-sm-3 col-sm-offset-1 blog-sidebar">
        <div class="sidebar-module sidebar-module-inset">
            <h4>Mike Hepburn</h4>
            <p>This is really working out great.</p>
            <ul>
                <li><a href="https://twitter.com/eformat">@eformat</a></li>
            </ul>
        </div>


        <div class="sidebar-module">
            <h4>Tags</h4>
            <ol class="list-unstyled" style="margin-left: 0px">
                

                <li><a href="openshift.html">openshift</a> (10)</li>
                

                <li><a href="gitops.html">gitops</a> (4)</li>
                

                <li><a href="java.html">java</a> (3)</li>
                

                <li><a href="quarkus.html">quarkus</a> (3)</li>
                

                <li><a href="acm.html">acm</a> (2)</li>
                

                <li><a href="aiml.html">aiml</a> (2)</li>
                

                <li><a href="argocd.html">argocd</a> (2)</li>
                

                <li><a href="gpu.html">gpu</a> (2)</li>
                

                <li><a href="stable diffusion.html">stable diffusion</a> (2)</li>
                

                <li><a href="analytics.html">analytics</a> (1)</li>
                

                <li><a href="api.html">api</a> (1)</li>
                

                <li><a href="apollo.html">apollo</a> (1)</li>
                

                <li><a href="aws.html">aws</a> (1)</li>
                

                <li><a href="bgp.html">bgp</a> (1)</li>
                

                <li><a href="bird.html">bird</a> (1)</li>
                

                <li><a href="constraints.html">constraints</a> (1)</li>
                

                <li><a href="cost.html">cost</a> (1)</li>
                

                <li><a href="devops.html">devops</a> (1)</li>
                

                <li><a href="disconnected.html">disconnected</a> (1)</li>
                

                <li><a href="fediverse.html">fediverse</a> (1)</li>
                

                <li><a href="fedora.html">fedora</a> (1)</li>
                

                <li><a href="flink.html">flink</a> (1)</li>
                

                <li><a href="frr.html">frr</a> (1)</li>
                

                <li><a href="graphql.html">graphql</a> (1)</li>
                

                <li><a href="load balancing.html">load balancing</a> (1)</li>
                

                <li><a href="mastodon.html">mastodon</a> (1)</li>
                

                <li><a href="metallb.html">metallb</a> (1)</li>
                

                <li><a href="networking.html">networking</a> (1)</li>
                

                <li><a href="optaplanner.html">optaplanner</a> (1)</li>
                

                <li><a href="patterns.html">patterns</a> (1)</li>
                

                <li><a href="platform.html">platform</a> (1)</li>
                

                <li><a href="platform as product.html">platform as product</a> (1)</li>
                

                <li><a href="plausible.html">plausible</a> (1)</li>
                

                <li><a href="policy.html">policy</a> (1)</li>
                

                <li><a href="pulsar.html">pulsar</a> (1)</li>
                

                <li><a href="registries.html">registries</a> (1)</li>
                

                <li><a href="security.html">security</a> (1)</li>
                

                <li><a href="service discovery.html">service discovery</a> (1)</li>
                

                <li><a href="sno.html">sno</a> (1)</li>
                

                <li><a href="social.html">social</a> (1)</li>
                

                <li><a href="stork.html">stork</a> (1)</li>
                

                <li><a href="streaming.html">streaming</a> (1)</li>
                

                <li><a href="teams.html">teams</a> (1)</li>
                

                <li><a href="vault.html">vault</a> (1)</li>
                

                <li><a href="vlans openshift.html">vlans openshift</a> (1)</li>
                

                <li><a href="web.html">web</a> (1)</li>
                
            </ol>
        </div>
    </div>

    </div>

		</div>
		<div id="push"></div>
    </div>
    
    <div id="footer">
      <div class="container">
        <p class="text-muted credit">Blog posts are published under Creative Commons license by-nc-sa <em>Creative Commons by-nc-sa</em>. <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png"/></a></p>
        <p class="text-muted credit">&copy; 2023 | Baked with <a href="http://jbake.org">JBake v2.7.0-rc.6</a><a href="https://github.com/eformat/blog.eformat.me/actions"> | Published Tue Aug 06 00:30:07 UTC 2024</a></p>
      </div>
    </div>
    
    <!-- Javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="../js/lightbox.js"></script>

    <!--script type="text/javascript">
        window.___gcfg = {lang: 'en'};

        (function() {
            var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
            po.src = 'https://apis.google.com/js/platform.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
        })();
    </script-->

    <!--script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-', '');
      ga('send', 'pageview');

    </script-->
    
  </body>
</html>

