<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    
    <title>eformat.me - load balancing</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="eformat.me : load balancing">
    <meta property="og:title" content="eformat.me - load balancing" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://blog.eformat.me/img/eformat.me.jpg" />
    <meta property="og:url" content="https://blog.eformat.me/tags/load balancing.html" />
    <meta property="og:description" content="eformat.me : load balancing" />
    <meta property="og:locale" content="en_GB" />
    <meta property="og:site_name" content="eformat.me" />

    <!-- Le styles -->
    <link href="../css/lightbox.css" rel="stylesheet">
    <link href="../css/yeti/bootstrap.min.css" rel="stylesheet">
    <link href="../css/base.css" rel="stylesheet">
    <link href="../css/asciidoctor.css" rel="stylesheet">
    <!-- link href="/css/bootstrap-theme.min.css" rel="stylesheet" -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../favicon.ico">

    <!-- WebAnalytics -->
    <script defer data-domain="blog.eformat.me" src="https://plausible.apps.sno.eformat.me/js/script.js"></script>
  </head>
  <body>
    <div id="wrap">

	
	      <!-- Fixed navbar -->
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container-fluid">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-menu">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../index.html">eformat.me</a>
          </div>
          <div class="collapse navbar-collapse" id="navbar-menu">
            <ul class="nav navbar-nav">
              <li><a href="https://github.com/eformat" target="github:eformat">Github</a></li>
              <li><a href="../archive.html">Archives</a></li>
              <li><a href="../feeds/posts/default.xml">Flux RSS</a></li>
              <li><a href="https://plausible.apps.sno.eformat.me/blog.eformat.me" target="eformat:analytics">Analytics</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
      <div class="container">


	<div class="page-header">
            <div class="row">
                <div class="col-xs-4 col-md-2"><img src="../img/eformat.me.jpg"></div>
                <div class="col-xs-12 col-md-8"><h1>Tag: load balancing</h1></div>
            </div>
	</div>

    <div class="row">

    <div class="col-sm-8">
        
            
                <a href="../2023/05/smallrye-stork-load-balancing.html"><h1>Service Discovery and Load Balancing with Stork</h1></a>
                <p>25 May 2023</p>

                <p>Tags :
                <a href="quarkus.html">quarkus</a>, <a href="service discovery.html">service discovery</a>, <a href="stork.html">stork</a>, <a href="load balancing.html">load balancing</a>, <a href="java.html">java</a>
                </p>

                <!--a href="https://twitter.com/share" class="twitter-share-button" data-url="http://www.eformat.me/2023/05/smallrye-stork-load-balancing.html" data-text="Service Discovery and Load Balancing with Stork" data-via="eformat" data-lang="en">Tweeter</a-->
                <!--script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script-->
                <div class="g-plusone" data-size="medium" data-href="http://www.eformat.me/2023/05/smallrye-stork-load-balancing.html"></div>

                <p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://smallrye.io/smallrye-stork/">Stork</a> is a service discovery and client-side load-balancing framework. Its one of those critical services you
find out you need when doing distributed services programming. Have a read of the docs, it integrates into common open source tooling such as Hashi&#8217;s <a href="https://www.consul.io">Consul</a> as
well as a host of others. Even-though OpenShift/Kubernetes has a built-in support for service discovery and load-balancing, you may need more flexibility to carefully select
the service instance you want.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dns_srv_for_service_discovery">DNS SRV for Service Discovery</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I wanted to try out good 'ol fashioned <a href="https://en.wikipedia.org/wiki/SRV_record">SRV Records</a> as a means to testing out the client side service discovery in Stork. Many people forget that
DNS itself supports service discovery for high service availability. It is still very commonly used, especially in mobile/telco.</p>
</div>
<div class="paragraph">
<p>My test case would be to create a DNS SRV record that queries OpenShift Cluster Canary Application endpoints. I&#8217;m using Route53 for DNS so you can read the
<a href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/ResourceRecordTypes.html#SRVFormat">SRV Records format here</a>. The first three records are priority, weight, and port.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="bash">1 10 443 canary-openshift-ingress-canary.apps.sno.eformat.me
1 10 443 canary-openshift-ingress-canary.apps.baz.eformat.me</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you curl one of these, you get a <code>Healthcheck requested</code> back if the service is running.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="bash">curl https://canary-openshift-ingress-canary.apps.sno.eformat.me
Healthcheck requested</code></pre>
</div>
</div>
<div class="paragraph">
<p>So, in my example, you can get a full list of SRV record values by querying:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="bash">dig SRV canary.demo.redhatlabs.dev</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_coding_a_quick_client">Coding a Quick Client</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For a quick and dirty client to make use of the SRV record I reach out for my favourite tools, yes Perl üê´üê´üê´ !</p>
</div>
<div class="paragraph">
<p>Let&#8217;s query the SRV record and see if my OpenShift clusters are healthy.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="perl5"># sudo dnf install -y perl-Net-DNS perl-WWW-Curl
use Net::DNS;
use WWW::Curl::Easy;
use Term::ANSIColor qw(:constants);

sub lookup {
  my ($dc) = @_;
  my $res = Net::DNS::Resolver-&gt; new;
  my $query = $res-&gt;send($dc, "SRV");
  if ($query) {
      foreach $rr ($query-&gt;answer) {
          next unless $rr-&gt;type eq 'SRV';
          # return first found
          return $rr-&gt;target;
      }
  } else {
      print("SRV lookup failed: " . $res-&gt;errorstring);
  }
  return;
}

my $host = lookup("canary.demo.redhatlabs.dev");
print GREEN, $host . "\n", RESET;
my $curl = WWW::Curl::Easy-&gt;new;
$curl-&gt;setopt(CURLOPT_HEADER,1);
$curl-&gt;setopt(CURLOPT_URL, 'https://' . $host);
$curl-&gt;setopt(CURLOPT_SSL_VERIFYHOST, 0);

my $retcode = $curl-&gt;perform;

if ($retcode == 0) {
    print("Transfer went ok\n");
    my $response_code = $curl-&gt;getinfo(CURLINFO_HTTP_CODE);
    print(GREEN, "Received response code: $response_code\n", RESET, "\n");
} else {
    print(RED, "An error happened: $retcode ". RESET . $curl-&gt;strerror($retcode)." ".$curl-&gt;errbuf."\n");
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course feel free to run this in a loop :) because each record is equally weighted in the SRV you will get a round-robin behaviour.</p>
</div>
<div id="lightbox"></div>
<div class="imageblock id="perl-srv">
  <img src="/2023/05/perl-srv.png" class="zoom">
</div>
<div class="paragraph">
<p>So, looking good so far.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_stork_and_java">Stork and Java</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Of course, the whole point was to try out Stork. Following the <a href="https://quarkus.io/guides/stork">Quarkus Stork</a> getting started guide, I used a simple rest client service</p>
</div>
<script src="https://gist.github.com/eformat/ef15dcd163d245aa2d6594627482f542.js"></script>
<div class="paragraph">
<p>and configured the <code>canary</code> stork service as follows:</p>
</div>
<script src="https://gist.github.com/eformat/1311409e0e7f1a60ece148a34288f754.js"></script>
<div class="paragraph">
<p>Unfortunately, this didn&#8217;t work as I expected! The SRV record values were <code>resolved</code> to IP addresses instead of returning the DNS name for me to query. The
issue with just an IP address is that Routing in OpenShift requires the HEAD/Location to be set properly so the correct endpoint Route can be routed and queried using HAProxy.</p>
</div>
<div id="lightbox"></div>
<div class="imageblock id="quarkus-stork-call-fail.png">
  <img src="/2023/05/quarkus-stork-call-fail.png" class="zoom">
</div>
<div class="paragraph">
<p>The Stork documentation spells out this DNS resolution process:</p>
</div>
<div id="lightbox"></div>
<div class="imageblock id="stork-query-1">
  <img src="/2023/05/stork-query-1.png" class="zoom">
</div>
<div class="paragraph">
<p>Looking at the source code, led me to submit this <a href="https://github.com/smallrye/smallrye-stork/pull/549/files">PR</a> which adds in an option so that you can skip the DNS resolution step.</p>
</div>
<div class="paragraph">
<p>So, adding this property using the new version of the Stork library:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="bash">quarkus.stork.canary.service-discovery.resolve-srv=false</code></pre>
</div>
</div>
<div class="paragraph">
<p>Leads to the DNS names being returned and no the ip addresses:</p>
</div>
<div id="lightbox"></div>
<div class="imageblock id="stork-query-2">
  <img src="/2023/05/stork-query-2.png" class="zoom">
</div>
<div class="paragraph">
<p>Trying out the code and now the Service call works as expected:</p>
</div>
<div id="lightbox"></div>
<div class="imageblock id="quarkus-stork-call-ok.png">
  <img src="/2023/05/quarkus-stork-call-ok.png" class="zoom">
</div>
<div class="paragraph">
<p>YAY ! ü¶ç Checkout <a href="https://github.com/eformat/stork-quickstart/tree/main">the source code here</a> and watch out for the next version of Stork !</p>
</div>
</div>
</div></p>
                <p><a href="2023/05/smallrye-stork-load-balancing.html#disqus_thread">Commentaires</a></p>
            

        

    </div>

    <div class="col-sm-3 col-sm-offset-1 blog-sidebar">
        <div class="sidebar-module sidebar-module-inset">
            <h4>Mike Hepburn</h4>
            <p>This is really working out great.</p>
            <ul>
                <li><a href="https://twitter.com/eformat">@eformat</a></li>
            </ul>
        </div>


        <div class="sidebar-module">
            <h4>Tags</h4>
            <ol class="list-unstyled" style="margin-left: 0px">
                

                <li><a href="openshift.html">openshift</a> (9)</li>
                

                <li><a href="gitops.html">gitops</a> (3)</li>
                

                <li><a href="java.html">java</a> (3)</li>
                

                <li><a href="quarkus.html">quarkus</a> (3)</li>
                

                <li><a href="aiml.html">aiml</a> (2)</li>
                

                <li><a href="argocd.html">argocd</a> (2)</li>
                

                <li><a href="gpu.html">gpu</a> (2)</li>
                

                <li><a href="stable diffusion.html">stable diffusion</a> (2)</li>
                

                <li><a href="acm.html">acm</a> (1)</li>
                

                <li><a href="analytics.html">analytics</a> (1)</li>
                

                <li><a href="api.html">api</a> (1)</li>
                

                <li><a href="apollo.html">apollo</a> (1)</li>
                

                <li><a href="aws.html">aws</a> (1)</li>
                

                <li><a href="bgp.html">bgp</a> (1)</li>
                

                <li><a href="bird.html">bird</a> (1)</li>
                

                <li><a href="constraints.html">constraints</a> (1)</li>
                

                <li><a href="cost.html">cost</a> (1)</li>
                

                <li><a href="devops.html">devops</a> (1)</li>
                

                <li><a href="disconnected.html">disconnected</a> (1)</li>
                

                <li><a href="fediverse.html">fediverse</a> (1)</li>
                

                <li><a href="fedora.html">fedora</a> (1)</li>
                

                <li><a href="flink.html">flink</a> (1)</li>
                

                <li><a href="frr.html">frr</a> (1)</li>
                

                <li><a href="graphql.html">graphql</a> (1)</li>
                

                <li><a href="load balancing.html">load balancing</a> (1)</li>
                

                <li><a href="mastodon.html">mastodon</a> (1)</li>
                

                <li><a href="metallb.html">metallb</a> (1)</li>
                

                <li><a href="optaplanner.html">optaplanner</a> (1)</li>
                

                <li><a href="patterns.html">patterns</a> (1)</li>
                

                <li><a href="platform.html">platform</a> (1)</li>
                

                <li><a href="platform as product.html">platform as product</a> (1)</li>
                

                <li><a href="plausible.html">plausible</a> (1)</li>
                

                <li><a href="pulsar.html">pulsar</a> (1)</li>
                

                <li><a href="registries.html">registries</a> (1)</li>
                

                <li><a href="security.html">security</a> (1)</li>
                

                <li><a href="service discovery.html">service discovery</a> (1)</li>
                

                <li><a href="sno.html">sno</a> (1)</li>
                

                <li><a href="social.html">social</a> (1)</li>
                

                <li><a href="stork.html">stork</a> (1)</li>
                

                <li><a href="streaming.html">streaming</a> (1)</li>
                

                <li><a href="teams.html">teams</a> (1)</li>
                

                <li><a href="vault.html">vault</a> (1)</li>
                

                <li><a href="web.html">web</a> (1)</li>
                
            </ol>
        </div>
    </div>

    </div>

		</div>
		<div id="push"></div>
    </div>
    
    <div id="footer">
      <div class="container">
        <p class="text-muted credit">Blog posts are published under Creative Commons license by-nc-sa <em>Creative Commons by-nc-sa</em>. <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png"/></a></p>
        <p class="text-muted credit">&copy; 2023 | Baked with <a href="http://jbake.org">JBake v2.7.0-rc.6</a><a href="https://github.com/eformat/blog.eformat.me/actions"> | Published Fri Jun 16 06:21:13 UTC 2023</a></p>
      </div>
    </div>
    
    <!-- Javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="../js/lightbox.js"></script>

    <!--script type="text/javascript">
        window.___gcfg = {lang: 'en'};

        (function() {
            var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
            po.src = 'https://apis.google.com/js/platform.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
        })();
    </script-->

    <!--script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-', '');
      ga('send', 'pageview');

    </script-->
    
  </body>
</html>

