<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    
    <title>eformat.me - gitops</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="eformat.me : gitops">
    <meta property="og:title" content="eformat.me - gitops" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://blog.eformat.me/img/eformat.me.jpg" />
    <meta property="og:url" content="https://blog.eformat.me/tags/gitops.html" />
    <meta property="og:description" content="eformat.me : gitops" />
    <meta property="og:locale" content="en_GB" />
    <meta property="og:site_name" content="eformat.me" />

    <!-- Le styles -->
    <link href="../css/lightbox.css" rel="stylesheet">
    <link href="../css/yeti/bootstrap.min.css" rel="stylesheet">
    <link href="../css/base.css" rel="stylesheet">
    <link href="../css/asciidoctor.css" rel="stylesheet">
    <!-- link href="/css/bootstrap-theme.min.css" rel="stylesheet" -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../favicon.ico">

    <!-- WebAnalytics -->
    <script defer data-domain="blog.eformat.me" src="https://plausible.apps.sno.eformat.me/js/script.js"></script>
  </head>
  <body>
    <div id="wrap">

	
	      <!-- Fixed navbar -->
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container-fluid">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-menu">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../index.html">eformat.me</a>
          </div>
          <div class="collapse navbar-collapse" id="navbar-menu">
            <ul class="nav navbar-nav">
              <li><a href="https://github.com/eformat" target="github:eformat">Github</a></li>
              <li><a href="../archive.html">Archives</a></li>
              <li><a href="../feeds/posts/default.xml">Flux RSS</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
      <div class="container">


	<div class="page-header">
            <div class="row">
                <div class="col-xs-4 col-md-2"><img src="../img/eformat.me.jpg"></div>
                <div class="col-xs-12 col-md-8"><h1>Tag: gitops</h1></div>
            </div>
	</div>

    <div class="row">

    <div class="col-sm-8">
        
            
                <a href="../2023/04/disconnected-registries.html"><h1>OpenShift Install, Semi-Connected Registries and Mirror by Digest Images</h1></a>
                <p>12 April 2023</p>

                <p>Tags :
                <a href="openshift.html">openshift</a>, <a href="gitops.html">gitops</a>, <a href="registries.html">registries</a>, <a href="disconnected.html">disconnected</a>
                </p>

                <!--a href="https://twitter.com/share" class="twitter-share-button" data-url="http://www.eformat.me/2023/04/disconnected-registries.html" data-text="OpenShift Install, Semi-Connected Registries and Mirror by Digest Images" data-via="eformat" data-lang="en">Tweeter</a-->
                <!--script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script-->
                <div class="g-plusone" data-size="medium" data-href="http://www.eformat.me/2023/04/disconnected-registries.html"></div>

                <p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>I have been working with disconnected OpenShift clusters quite a lot recently. One of the things you need to deal with is disconnected registries and mirror by digest images.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_quay_transparent_proxy_pull_through_cache">Quay Transparent Proxy-Pull Through Cache</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are a couple general approaches to configuring registries when disconnected. The <a href="https://docs.openshift.com/container-platform/4.12/installing/disconnected_install/index.html">product documentation</a> has great depth of detail about using a Quay Mirror Registry. This is the right approach when wanting disconnected. The downside when you are testing things out in a lab is the mirror import process is both time-consuming and uses a lot of disk space.</p>
</div>
<div class="paragraph">
<p>One approach i have become fond of is a what i call a <code>semi-connected</code> method, where your clusters' use a <a href="https://www.youtube.com/watch?v=oVlRDuCD6ic">Quay Transparent Proxy-Pull Through Cache</a> to speed things up. This still uses disk space, but you don&#8217;t need to import all the images before installing a cluster.</p>
</div>
<div class="paragraph">
<p>After you install the quay mirror registry on the provisioning host, set this in your <code>config.yaml</code> and restart the quay pods or service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="bash">FEATURE_PROXY_CACHE: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>This setup mimics what you would need to do when disconnected i.e. we always pull from the mirror registry when installing - but it is quicker to test as the mirror registry is connected. When configuring the OpenShift install method, the pull secret i use is <strong>just</strong> to the mirror. More on that below.</p>
</div>
<div class="paragraph">
<p>If you also set the cache timeout for your Organisations to be months or even years! then your images will hang around for a long time.</p>
</div>
<div class="paragraph">
<p>For installing OpenShift, you really need (at a minimum) two mirror organisations. I set up these two (admin is a default):</p>
</div>
<div id="lightbox"></div>
<div class="imageblock id="quay-mirror-orgs">
  <img src="/2023/04/quay-mirror-orgs.png" class="zoom">
</div>
<div class="paragraph">
<p>Where each Organisation points to these registries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="bash">registry-redhat-io -&gt; registry.redhat.io
ocp4-mirror -&gt; quay.io/openshift-release-dev</code></pre>
</div>
</div>
<div class="paragraph">
<p>One nice trick is that you can <strong>base64 decode</strong> your Red Hat <strong>pull-secret</strong> (you download this from cloud.redhat.com) and use those credentials in the Organisation mirror registry setup for authentication.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ocp_install_configuration">OCP Install Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now comes for the tricky part - configuring your OpenShift installer setup. There are a several ways to do this. The one you use depends on your install method and how you wish to control the <strong>registries.conf</strong> that gets configured for you cluster nodes.</p>
</div>
<div class="paragraph">
<p>I have been working with the <strong>Agent-based</strong> installer method for Bare Metal (i fake it on libvirt with sushy) - you can <a href="https://github.com/eformat/acm-gitops-ocp">check out all the code here</a>.</p>
</div>
<div class="paragraph">
<p>The issue i think everyone quickly discovers is that the OpenShift installer sets all mirror&#8217;s by digest to be true i.e. <strong>mirror-by-digest-only = true</strong>. If you check the <a href="https://github.com/openshift/installer">installer code</a> its here:</p>
</div>
<div id="lightbox"></div>
<div class="imageblock id="ocp-installer-boostrap">
  <img src="/2023/04/ocp-installer-boostrap.png" class="zoom">
</div>
<div class="paragraph">
<p>Setting mirror by digest to true is intentional, it helps stop image spoofing or getting an image from a moving tag.</p>
</div>
<div class="paragraph">
<p>Unfortunately not all Operators pull by digest either. In fact the deployments that are part of the <strong>openshift-marketplace</strong> do not. So after a cluster install we see Image Pull errors like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="bash">$ oc get pods -n openshift-marketplace
NAME                                   READY   STATUS             RESTARTS      AGE
certified-operators-d2nd9              0/1     ImagePullBackOff   0             15h
certified-operators-pqrlz              0/1     ImagePullBackOff   0             15h
community-operators-7kpbm              0/1     ImagePullBackOff   0             15h
community-operators-k662l              0/1     ImagePullBackOff   0             15h
marketplace-operator-84457bfc9-v22db   1/1     Running            4 (15h ago)   16h
redhat-marketplace-kjrt9               0/1     ImagePullBackOff   0             15h
redhat-marketplace-sqch2               0/1     ImagePullBackOff   0             15h
redhat-operators-4m4gt                 0/1     ImagePullBackOff   0             15h
redhat-operators-62z6x                 0/1     ImagePullBackOff   0             15h</code></pre>
</div>
</div>
<div class="paragraph">
<p>And checking one of the pods we see it is trying to pull by tag:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="bash">$ oc describe pod certified-operators-d2nd9
Normal  BackOff  2m2s (x4179 over 15h)  kubelet  Back-off pulling image "registry.redhat.io/redhat/certified-operator-index:v4.12"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unfortunately you cannot configure <strong>ImageContentSourcePolicy</strong> for <strong>mirror-by-digest-only = false</strong> so (currently) the only solution is to apply MachineConfig <strong>post</strong> your install as a day#2 thing as documented in this <a href="https://access.redhat.com/solutions/4817401">Knowledge Base Article</a></p>
</div>
<div class="paragraph">
<p>Hopefully in an upcoming OpenShift relaease (4.13 or 4.14) we will be able to use the <strong>new API&#8217;s for CRDs ImageDigestMirrorSet ImageTagMirrorSet</strong> - see <a href="https://issues.redhat.com/browse/OCPNODE-521">Allow mirroring images by tags</a> RFE for more details on these changes.</p>
</div>
<div class="paragraph">
<p>For now though, i use <strong>butane</strong> and MachineConfig as per the KB article at post install time to configure <strong>mirror-by-digest-only = false</strong> for my mirror registries that need it. From my <a href="https://github.com/eformat/acm-gitops-ocp">git repo</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="bash">butane 99-master-mirror-by-digest-registries.bu -o 99-master-mirror-by-digest-registries.yaml
oc apply -f 99-master-mirror-by-digest-registries.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will reboot your nodes to apply the MCP, you may add or change the butane template(s) and yaml to suit the nodes you need to target e.g. masters or workers (or any other) node role. In my case it&#8217;s targeting a SNO cluster so master is fine.</p>
</div>
<div class="paragraph">
<p>All going well your marketplace pods should now pull images and run OK</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="bash">$ oc get pods -n openshift-marketplace
NAME                                   READY   STATUS    RESTARTS   AGE
certified-operators-d2nd9              1/1     Running   0          16h
community-operators-k662l              1/1     Running   0          16h
marketplace-operator-84457bfc9-v22db   1/1     Running   5          16h
redhat-marketplace-kjrt9               1/1     Running   0          16h
redhat-operators-62z6x                 1/1     Running   0          16h</code></pre>
</div>
</div>
<div class="paragraph">
<p>A word of warning when using the Assited Installer / Agent Installer method. If you try to set <strong>mirror-by-digest-only = false</strong> registries in your <strong>AgentServiceConfig</strong> using the provided ConfigMap e.g. something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: quay-mirror-config
  namespace: multicluster-engine
  labels:
    app: assisted-service
data:
  LOG_LEVEL: "debug"
  ca-bundle.crt: |
    -----BEGIN CERTIFICATE-----
    ! Put you CA for your mirror registry here !
    -----END CERTIFICATE-----

  registries.conf: |
    unqualified-search-registries = ["registry.redhat.io", "registry.access.redhat.com", "docker.io"]

    [[registry]]
      prefix = ""
      location = "registry.redhat.io/redhat"
      mirror-by-digest-only = false
      [[registry.mirror]]
        location = "quay.eformat.me:8443/registry-redhat-io/redhat"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The registry mirror setting will get reset to <strong>mirror-by-digest-only = true</strong> by the installer.</p>
</div>
<div class="paragraph">
<p>Similarly, if you try and set MachineConfig in the <strong>ignitionConfigOverride</strong> in the <strong>InfraEnv</strong> e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yaml">apiVersion: agent-install.openshift.io/v1beta1
kind: InfraEnv
...
  # User for modify ignition during discovery
  ignitionConfigOverride: '{"ignition": {"version": "3.1.0"}, "storage": {"files": [{"path": "/etc/containers/registries.conf", "mode": 420, "overwrite": true, "user": { "name": "root"},"contents": {"source": "data:text/plain;base64,dW5xd..."}}]}}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>it also gets overriden by the installer. I tried both these methods and failed üò≠üò≠</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For now, the only way to configure <strong>mirror-by-digest-only = false</strong> is via MachineConfig <strong>post-install</strong>.</p>
</div>
<div class="paragraph">
<p>You can always <strong>try</strong> and only mirror images by digest, just remember that various operators and components may not be configured this work this way.</p>
</div>
<div class="paragraph">
<p>The future looks bright with the new API&#8217;s, as this has been a long-standing issue now.</p>
</div>
<div class="paragraph">
<p>üèÖGood luck installing out there !!</p>
</div>
</div>
</div></p>
                <p><a href="2023/04/disconnected-registries.html#disqus_thread">Commentaires</a></p>
            

        
            
                <a href="../2023/02/acm-team-argocd.html"><h1>ACM &amp; ArgoCD for Teams</h1></a>
                <p>17 February 2023</p>

                <p>Tags :
                <a href="openshift.html">openshift</a>, <a href="argocd.html">argocd</a>, <a href="acm.html">acm</a>, <a href="gitops.html">gitops</a>
                </p>

                <!--a href="https://twitter.com/share" class="twitter-share-button" data-url="http://www.eformat.me/2023/02/acm-team-argocd.html" data-text="ACM &amp; ArgoCD for Teams" data-via="eformat" data-lang="en">Tweeter</a-->
                <!--script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script-->
                <div class="g-plusone" data-size="medium" data-href="http://www.eformat.me/2023/02/acm-team-argocd.html"></div>

                <p><div class="sect1">
<h2 id="_quickly_deploying_argocd_applicationsets_using_rhacms_global_clusterset">Quickly deploying ArgoCD ApplicationSets using RHACM&#8217;s Global ClusterSet</h2>
<div class="sectionbody">
<div id="lightbox"></div>
<div class="imageblock id="gpu-concurrency-mechanisms">
  <img src="/2023/02/sre-cluster-argo-team-namespaced.png" class="zoom">
</div>
<div class="paragraph">
<p>I have <a href="https://github.com/eformat/argocd-team-topologies">written about</a> how we can align our Tech to setup GitOps tooling so that it fits with our team structure.</p>
</div>
<div class="paragraph">
<p>How can we make these patterns real using tools like Advanced Cluster Manager (ACM) that help us deploy to a fleet of Clusters ? ACM supports <code>Policy</code> based deployments so we can track compliance of our clusters to the expected configuration management policy.</p>
</div>
<div class="paragraph">
<p>The source code is here - <a href="https://github.com/eformat/acm-gitops" class="bare">https://github.com/eformat/acm-gitops</a> - git clone it so you can follow along.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_global_clustersets">Global ClusterSet&#8217;s</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When a cluster is managed in ACM there are several resources created out of the box <a href="https://access.redhat.com/documentation/en-us/red_hat_advanced_cluster_management_for_kubernetes/2.6/html-single/multicluster_engine/index#managedclustersets_global">you can read about them here</a> in the documentation. This includes a namespace called <code>open-cluster-management-global-set</code>. We can quickly deploy <code>ApplicationSet&#8217;s</code> in this global-namespace that generates <code>Policy</code> to create our team based ArgoCD instances.</p>
</div>
<div class="paragraph">
<p>We can leverage the fact that <code>ApplicationSet&#8217;s</code> can be associated with a <code>Placement</code> - that way we can easily control where our <code>Policy</code> and <code>Team ArgoCD&#8217;s</code> are deployed across our fleet of OpenShift clusters by using simple label selectors for example.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_bootstrap_a_cluster_scoped_argocd_for_our_policies">Bootstrap a Cluster Scoped ArgoCD for our Policies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We are going Bootstrap a cluster-scoped ArgoCD instance into the <code>open-cluster-management-global-set</code> namespace.</p>
</div>
<div class="paragraph">
<p>We will deploy our Team ArgoCD&#8217;s using ACM <code>Policy</code> that is generated using the <code>PolicyGenerator</code> tool <a href="https://github.com/stolostron/policy-generator-plugin/blob/main/docs/policygenerator-reference.yaml">which you can read about here from its' reference file</a>.</p>
</div>
<div class="paragraph">
<p>Make sure to label the cluster&#8217;s where you want to deploy to with <code>useglobal=true</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="bash">oc apply -f bootstrap-acm-global-gitops/setup.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>This deploys the following resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Subscription</code> Resource - The GitOps operator <code>Subscription</code>, including disabling the default ArgoCD and setting cluster-scoped connections for our namespaces - see the <code>ARGOCD_CLUSTER_CONFIG_NAMESPACES</code> env.var that is part of the <code>Subscription</code> object. If your namespace is not added here, you will get namespace scoped connections for your ArgoCD, rather than all namespaces.</p>
</li>
<li>
<p><code>GitOpsCluster</code> Resource - This resource provides a Connection between ArgoCD-Server and the Placement (where to deploy exactly the Application).</p>
</li>
<li>
<p><code>Placement</code> Resource - We use a <code>Placement</code> resource for this global ArgoCD which deploys to a fleet of Clusters, where the Clusters needs to be labeled with <code>useglobal=true</code>.</p>
</li>
<li>
<p><code>ArgoCD</code> Resource - The CR for our global ArgoCD where we will deploy Policy. We configure ArgoCD to download the <code>PolicyGenerator</code> binary, and configure kustomize to run with the setting:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yaml">kustomizeBuildOptions: --enable-alpha-plugins</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_the_team_based_argocd_using_generated_policy">Deploy the Team Based ArgoCD using Generated Policy</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We are going to deploy ArgoCD for two teams now using the ACM <code>PolicyGenerator</code>.</p>
</div>
<div class="paragraph">
<p>The <code>PolicyGenerator</code> runs using kustomize. We specify the <code>generator-input/</code> folder - that holds our YAML manifests for each ArgoCD - in this case one for <code>fteam</code>, one for <code>zteam</code>.</p>
</div>
<div class="paragraph">
<p>You can run the <code>PolicyGenerator</code> from the CLI to test it out before deploying - download it using the <a href="https://github.com/stolostron/policy-generator-plugin/blob/main/README.md)">instructions here</a> e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="bash">kustomize build --enable-alpha-plugins team-gitops-policy/</code></pre>
</div>
</div>
<div class="paragraph">
<p>We specify the placement rule <code>placement-team-argo</code> - where the Clusters needs to be labeled with <code>teamargo=true</code>.</p>
</div>
<div class="paragraph">
<p>We add some default compliance and control labels for grouping purposes in ACM Governance.</p>
</div>
<div class="paragraph">
<p>We also set the <code>pruneObjectBehavior: "DeleteAll</code> so that if we delete the <code>ApplicationSet</code> the generated <code>Policy</code> s deleted and all objects are removed. For this to work, we must also set the <code>remediationAction</code> to <code>enforce</code> for our Policies.</p>
</div>
<div class="paragraph">
<p>One last configuration is to set the ArgoCD <code>IgnoreExtraneous</code> compare option - as Policy is generated we do not want ArgoCD to be out of sync for these objects.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yaml">apiVersion: policy.open-cluster-management.io/v1
kind: PolicyGenerator
metadata:
  name: argocd-teams
placementBindingDefaults:
  name: argocd-teams
policyDefaults:
  placement:
    placementName: placement-team-argo
  categories:
    - CM Configuration Management
  complianceType: "musthave"
  controls:
    - CM-2 Baseline Configuration
  consolidateManifests: false
  disabled: false
  namespace: open-cluster-management-global-set
  pruneObjectBehavior: "DeleteAll"
  remediationAction: enforce
  severity: medium
  standards:
    - generic
  policyAnnotations: {"argocd.argoproj.io/compare-options": "IgnoreExtraneous"}
policies:
  - name: team-gitops
    manifests:
      - path: generator-input/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure to label the cluster&#8217;s where you want to deploy to with <code>teamargo=true</code>.</p>
</div>
<div class="paragraph">
<p>To create our Team ArgoCD&#8217;s run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="bash">oc apply -f applicationsets/team-argo-appset.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>To delete them, remove the <code>AppSet</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="bash">oc delete appset team-argo</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can now take this pattern and deploy it across multiple clusters that are managed by ACM. You can easily scale out the number of Team Based ArgoCD and have fine grained control over their individual configuration including third party plugins like Vault. ACM offers a single plane of glass to check if your clusters are compliant to the generated policies, and if not - take remedial action.</p>
</div>
<div class="paragraph">
<p>You can see the code in action in this video.</p>
</div>
<div class="videoblock">
<div class="content">
<iframe width="800" height="600" src="https://www.youtube.com/embed/eGxPMkADAbc?rel=0" frameborder="0" allowfullscreen></iframe>
</div>
</div>
<div class="paragraph">
<p>üèÖEnjoy !!</p>
</div>
</div>
</div></p>
                <p><a href="2023/02/acm-team-argocd.html#disqus_thread">Commentaires</a></p>
            

        
            
                <a href="../2022/11/argocd-patterns-vault.html"><h1>Patterns with ArgoCD - Vault</h1></a>
                <p>04 November 2022</p>

                <p>Tags :
                <a href="argocd.html">argocd</a>, <a href="gitops.html">gitops</a>, <a href="patterns.html">patterns</a>, <a href="vault.html">vault</a>, <a href="security.html">security</a>
                </p>

                <!--a href="https://twitter.com/share" class="twitter-share-button" data-url="http://www.eformat.me/2022/11/argocd-patterns-vault.html" data-text="Patterns with ArgoCD - Vault" data-via="eformat" data-lang="en">Tweeter</a-->
                <!--script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script-->
                <div class="g-plusone" data-size="medium" data-href="http://www.eformat.me/2022/11/argocd-patterns-vault.html"></div>

                <p><div class="sect1">
<h2 id="_team_collaboration_with_argocd">Team Collaboration with ArgoCD</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I have written before about collaborating using GitOps, ArgoCD and Red Hat GitOps Operator. How can we better align our deployments with our teams ?</p>
</div>
<div class="paragraph">
<p>The array of patterns and the helm chart are described <a href="https://github.com/redhat-cop/helm-charts/blob/master/charts/gitops-operator/TEAM_DOCS.md">in a fair bit of detail here</a>. I want to talk about using one of these patterns at scale - hundred&#8217;s of apps across multiple clusters.</p>
</div>
<div class="sect2">
<h3 id="_platform_cluster_argocd_tenant_team_argocds">Platform Cluster ArgoCD, Tenant Team ArgoCD&#8217;s</h3>
<div class="paragraph">
<p>For Product Teams working in large organisations that have a central Platform Team - this pattern is probably the most natural i think.</p>
</div>
<div id="lightbox"></div>
<div class="imageblock id="sre-cluster-argo-team-namespaced">
  <img src="/2022/11/sre-cluster-argo-team-namespaced.png" class="zoom">
  <div class="title">Figure - Platform ArgoCD, Namespaced ArgoCD per Team</div>
</div>
<div class="paragraph">
<p>It allows the platform team to control cluster and elevated privileges, activities like controlling namespaces, configuring cluster resources etc, in their Cluster Scoped ArgoCD, whilst Product Teams can control their namespaces independently of them.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The RedHat GitOps Operator (cluster scoped)</p>
</li>
<li>
<p>Platform Team (cluster scoped) ArgoCD instance</p>
</li>
<li>
<p>Team (namespace scoped) ArgoCD instances</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When doing multi-cluster, i usually prefer to have ArgoCD <em>"in the cluster"</em> rather than remotely controlling a cluster. This seems better from an availability / single point of failure point of view. Of course if its a more <em>edge</em> use case, remote cluster connections may make sense.</p>
</div>
<div class="paragraph">
<p>OK, so the Tenant ArgoCD is deployed in <strong>namespaced</strong> mode and controls multiple namespaces belonging to a team. For each Team, a single ArgoCD instance per cluster normally suffices. You can scale up and shard the argo controllers, run in HA - not usually necessary at team scale (100 apps) - see the argocd doco if you need to do this though. There may be multiple non-production clusters - dev, test, qa etc and then you will have multiple production clusters (prod + dr etc) - each cluster have their own ArgoCD instances per Team.</p>
</div>
<div class="paragraph">
<p>All of this is controlled via gitops. A sensible code split is one git repo per team, so one for the Platform Team, one for each Product Team - i normally start with a mono repo and split later based on need or scale.</p>
</div>
<div class="paragraph">
<p>It is worth pointing out that any elevated cluster RBAC permissions that are needed by the Product Teams' are done via git PR&#8217;s into the platform team&#8217;s gitops repo. Once configured, the Tenant team is in control of their namespaces and can get on with managing their own products and tooling.</p>
</div>
</div>
<div class="sect2">
<h3 id="_secrets_management_with_argocd_vault_plugin">Secrets Management with ArgoCD Vault Plugin</h3>
<div class="paragraph">
<p>To make this work at scale and in production within an organisation, the "batteries" for secrets management must be included! They are table stakes really. It&#8217;s fiddly, but worth the effort.</p>
</div>
<div class="paragraph">
<p>There are many ways to do secrets management beyond k8s secrets - <a href="https://cloud.redhat.com/blog/a-guide-to-gitops-and-secret-management-with-argocd-operator-and-sops">KSOPS</a>, <a href="https://external-secrets.io">External Secrets Operator</a> etc. The method i want to talk about uses the <a href="https://argocd-vault-plugin.readthedocs.io/en/stable/backends/">ArgoCD Vault Plugin</a> which i will abbreviate to <strong>AVP</strong>. It supports multiple secret backends by the way. In this case, i am going to use <a href="https://developer.hashicorp.com/vault/docs/auth/kubernetes">Hashicorp Vault</a> and the k8s integration auth method. Setting up vault is dealt with <a href="https://eformat.github.io/vault-quickstart/">separately</a> but can be done on-cluster or off-cluster.</p>
</div>
<div class="paragraph">
<p>To get AVP working, you basically deploy the ArgoCD repo server with a ServiceAccount and use that secret to authenticate to Hashi Vault using k8s auth method. This way each ArgoCD instance uses the token associated with that service account to authenticate. Note that in OpenShift 4.11+ when creating new service accounts (SA), a service account token secret is <a href="https://docs.openshift.com/container-platform/4.11/nodes/pods/nodes-pods-secrets.html#nodes-pods-secrets-creating-sa_nodes-pods-secrets">no longer automatically generated.</a></p>
</div>
<div class="paragraph">
<p>Once done, our app secrets can be easily referenced from within source code using either annotations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yaml">kind: Secret
apiVersion: v1
metadata:
  name: example-secret
  annotations:
    avp.kubernetes.io/path: "path/to/app-secret"
type: Opaque
data:
  password: &lt;password-vault-key&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>or directly via the full path:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yaml">  password: &lt;path:kv/data/path/to/app-secret#password-vault-key&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can also reference the secrets directly from our ArgoCD Application definitions. Here is an example of using helm (kustomize and plain yaml are also supported).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yaml">  source:
    repoURL: https://github.com/eformat/my-gitrepo.git
    path: gitops/my-app/chart
    targetRevision: main
    plugin:
      name: argocd-vault-plugin-helm
      env:
        - name: HELM_VALUES
          value: |
            image:
              repository: image-registry.openshift-image-registry.svc:5000/my-namespace/my-app
              tag: "1.2.3"
            password: &lt;path:kv/data/path/to/app-secret#password-vault-key&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>I also use a pattern to pass the <em>vault annotation path</em> down to the helm chart from the ArgoCD Application. To keep things clean (and you sane!) I normally have a Vault secret per-application (containing many KV2 - key:value pairs).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yaml">    plugin:
      name: argocd-vault-plugin-helm
      env:
        - name: HELM_VALUES
          value: |
            resources:
              limits:
                cpu: 500m         # a non secret value
            avp:
              secretPath: "kv/data/path/to/app-secret"  # use this in the annotations</code></pre>
</div>
</div>
<div class="paragraph">
<p>This allows you to control the <strong>path</strong> to your secrets in Vault which can be configured by convention e.g.  <strong>kv/data/cluster/namespace/app</strong> as an example.</p>
</div>
</div>
<div class="sect2">
<h3 id="_argocd_configuration_the_gory_details">ArgoCD Configuration - The Gory Details</h3>
<div class="paragraph">
<p>OK, great. But how do i get there with my Team ArgoCD ? Let&#8217;s take a look in depth at the <a href="https://github.com/redhat-cop/helm-charts/blob/master/charts/gitops-operator/values.yaml"><strong>argocd-values.yaml</strong></a> file you might pass into the gitops-operator helm chart to bootstrap your ArgoCD.</p>
</div>
<div class="paragraph">
<p>The important bit for AVP integration is to mount the token from a service account that we have created - in this case the service account is called <strong>argocd-repo-vault</strong> and we set <strong>mountastoken</strong> to "true".</p>
</div>
<div class="paragraph">
<p>Next, we use an <strong>initContainer</strong> to download the AVP go binary and save it to a <strong>custom-tools</strong> directory. If you are doing this disconnected, the binary needs to be made available offline.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yaml">argocd_cr:
  statusBadgeEnabled: true
  repo:
    mountsatoken: true
    serviceaccount: argocd-repo-vault
    volumes:
    - name: custom-tools
      emptyDir: {}
    initContainers:
    - name: download-tools
      image: registry.access.redhat.com/ubi8/ubi-minimal:latest
      command: [sh, -c]
      env:
        - name: AVP_VERSION
          value: "1.11.0"
      args:
        - &gt;-
          curl -Lo /tmp/argocd-vault-plugin https://github.com/argoproj-labs/argocd-vault-plugin/releases/download/v\${AVP_VERSION}/argocd-vault-plugin_\${AVP_VERSION}_linux_amd64 &amp;&amp; chmod +x /tmp/argocd-vault-plugin &amp;&amp; mv /tmp/argocd-vault-plugin /custom-tools/
      volumeMounts:
      - mountPath: /custom-tools
        name: custom-tools
    volumeMounts:
    - mountPath: /usr/local/bin/argocd-vault-plugin
      name: custom-tools
      subPath: argocd-vault-plugin</code></pre>
</div>
</div>
<div class="paragraph">
<p>We need to create the <em>glue</em> between our ArgoCD Applications' and how they call/use the AVP binary. This is done using the <strong>configManagementPlugins</strong> stanza. Note we use three methods, one for plain YAML, one for helm charts, one for kustomize. The plugin <strong>name:</strong> is what we reference from our ArgoCD Application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yaml">  configManagementPlugins: |
    - name: argocd-vault-plugin
      generate:
        command: ["sh", "-c"]
        args: ["argocd-vault-plugin -s team-ci-cd:team-avp-credentials generate ./"]
    - name: argocd-vault-plugin-helm
      init:
        command: [sh, -c]
        args: ["helm dependency build"]
      generate:
        command: ["bash", "-c"]
        args: ['helm template "$ARGOCD_APP_NAME" -n "$ARGOCD_APP_NAMESPACE" -f &lt;(echo "$ARGOCD_ENV_HELM_VALUES") . | argocd-vault-plugin generate -s team-ci-cd:team-avp-credentials -']
    - name: argocd-vault-plugin-kustomize
      generate:
        command: ["sh", "-c"]
        args: ["kustomize build . | argocd-vault-plugin -s team-ci-cd:team-avp-credentials generate -"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>We make use of environment variables set within the AVP plugin for helm so that the namespace and helm values from the ArgoCD Application are set correctly. See the <a href="https://argocd-vault-plugin.readthedocs.io/en/stable/usage/">AVP documentation</a> for full details of usage.</p>
</div>
<div class="paragraph">
<p>One thing to note, is the <strong>team-ci-cd:team-avp-credentials</strong> secret. This specifies <em>how</em> the AVP binary connects and authenticates to Hashi Vault. It is a secret that you need to set up. An example as follows for a simple hashi vault in-cluster deployment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="bash">export AVP_TYPE=vault
export VAULT_ADDR=https://vault-active.hashicorp.svc:8200   # vault url
export AVP_AUTH_TYPE=k8s                              # kubernetes auth
export AVP_K8S_ROLE=argocd-repo-vault                 # vault role (service account name)
export VAULT_SKIP_VERIFY=true
export AVP_MOUNT_PATH=auth/$BASE_DOMAIN-$PROJECT_NAME

cat &lt;&lt;EOF | oc apply -n ${PROJECT_NAME} -f-
---
apiVersion: v1
stringData:
  VAULT_ADDR: "${VAULT_ADDR}"
  VAULT_SKIP_VERIFY: "${VAULT_SKIP_VERIFY}"
  AVP_AUTH_TYPE: "${AVP_AUTH_TYPE}"
  AVP_K8S_ROLE: "${AVP_K8S_ROLE}"
  AVP_TYPE: "${AVP_TYPE}"
  AVP_K8S_MOUNT_PATH: "${AVP_MOUNT_PATH}"
kind: Secret
metadata:
  name: team-avp-credentials
  namespace: ${PROJECT_NAME}
type: Opaque
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>I am leaving out the gory details of Vault/ACL setup which are documented <a href="https://eformat.github.io/vault-quickstart/">elsewhere</a>, however to create the auth secret in vault from the <strong>argocd-repo-vault</strong> ServiceAccount token, i use this shell script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="bash">export SA_TOKEN=$(oc -n ${PROJECT_NAME} get sa/${APP_NAME} -o yaml | grep ${APP_NAME}-token | awk '{print $3}')
export SA_JWT_TOKEN=$(oc -n ${PROJECT_NAME} get secret $SA_TOKEN -o jsonpath="{.data.token}" | base64 --decode; echo)
export SA_CA_CRT=$(oc -n ${PROJECT_NAME} get secret $SA_TOKEN -o jsonpath="{.data['ca\.crt']}" | base64 --decode; echo)

vault write auth/$BASE_DOMAIN-${PROJECT_NAME}/config \
  token_reviewer_jwt="$SA_JWT_TOKEN" \
  kubernetes_host="$(oc whoami --show-server)" \
  kubernetes_ca_cert="$SA_CA_CRT"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_why_do_all_of_this">Why Do All of This ?</h3>
<div class="paragraph">
<p>The benefit of all this gory configuration stuff:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>we can now store secrets safely in a backend vault at enterprise scale</p>
</li>
<li>
<p>we have all of our ArgoCD&#8217;s use these secrets consistently with gitops in a multi-tenanted manner</p>
</li>
<li>
<p>we keep secrets values out of our source code</p>
</li>
<li>
<p>we can control all of this with gitops</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It also means that the platform an product teams, can manage secrets in a safely consistent manner - but separately i.e. each team manages their own secrets and space in vault. This method also works if you are using the enterprise Hashi vault that uses <strong>namespaces</strong> - you can just set the env.var into your ArgoCD Application like so.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yaml">    plugin:
      name: argocd-vault-plugin-kustomize
      env:
        - name: VAULT_NAMESPACE
          value: "my-team-apps"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tenant team&#8217;s are now fully in control of their namespaces and secrets and can get on with managing their own applications, products and tools !</p>
</div>
</div>
</div>
</div></p>
                <p><a href="2022/11/argocd-patterns-vault.html#disqus_thread">Commentaires</a></p>
            

        

    </div>

    <div class="col-sm-3 col-sm-offset-1 blog-sidebar">
        <div class="sidebar-module sidebar-module-inset">
            <h4>Mike Hepburn</h4>
            <p>This is really working out great.</p>
            <ul>
                <li><a href="https://twitter.com/eformat">@eformat</a></li>
            </ul>
        </div>


        <div class="sidebar-module">
            <h4>Tags</h4>
            <ol class="list-unstyled" style="margin-left: 0px">
                

                <li><a href="openshift.html">openshift</a> (8)</li>
                

                <li><a href="gitops.html">gitops</a> (3)</li>
                

                <li><a href="aiml.html">aiml</a> (2)</li>
                

                <li><a href="argocd.html">argocd</a> (2)</li>
                

                <li><a href="gpu.html">gpu</a> (2)</li>
                

                <li><a href="java.html">java</a> (2)</li>
                

                <li><a href="stable diffusion.html">stable diffusion</a> (2)</li>
                

                <li><a href="acm.html">acm</a> (1)</li>
                

                <li><a href="aws.html">aws</a> (1)</li>
                

                <li><a href="bgp.html">bgp</a> (1)</li>
                

                <li><a href="bird.html">bird</a> (1)</li>
                

                <li><a href="constraints.html">constraints</a> (1)</li>
                

                <li><a href="cost.html">cost</a> (1)</li>
                

                <li><a href="devops.html">devops</a> (1)</li>
                

                <li><a href="disconnected.html">disconnected</a> (1)</li>
                

                <li><a href="fediverse.html">fediverse</a> (1)</li>
                

                <li><a href="fedora.html">fedora</a> (1)</li>
                

                <li><a href="flink.html">flink</a> (1)</li>
                

                <li><a href="frr.html">frr</a> (1)</li>
                

                <li><a href="mastodon.html">mastodon</a> (1)</li>
                

                <li><a href="metallb.html">metallb</a> (1)</li>
                

                <li><a href="optaplanner.html">optaplanner</a> (1)</li>
                

                <li><a href="patterns.html">patterns</a> (1)</li>
                

                <li><a href="platform.html">platform</a> (1)</li>
                

                <li><a href="platform as product.html">platform as product</a> (1)</li>
                

                <li><a href="pulsar.html">pulsar</a> (1)</li>
                

                <li><a href="quarkus.html">quarkus</a> (1)</li>
                

                <li><a href="registries.html">registries</a> (1)</li>
                

                <li><a href="security.html">security</a> (1)</li>
                

                <li><a href="sno.html">sno</a> (1)</li>
                

                <li><a href="social.html">social</a> (1)</li>
                

                <li><a href="streaming.html">streaming</a> (1)</li>
                

                <li><a href="vault.html">vault</a> (1)</li>
                
            </ol>
        </div>
    </div>

    </div>

		</div>
		<div id="push"></div>
    </div>
    
    <div id="footer">
      <div class="container">
        <p class="text-muted credit">Blog posts are published under Creative Commons license by-nc-sa <em>Creative Commons by-nc-sa</em>. <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png"/></a></p>
        <p class="text-muted credit">&copy; 2022 | Baked with <a href="http://jbake.org">JBake v2.7.0-rc.6</a><a href="https://github.com/eformat/blog.eformat.me/actions"> | Published Sat May 06 23:51:14 UTC 2023</a></p>
      </div>
    </div>
    
    <!-- Javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="../js/lightbox.js"></script>

    <!--script type="text/javascript">
        window.___gcfg = {lang: 'en'};

        (function() {
            var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
            po.src = 'https://apis.google.com/js/platform.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
        })();
    </script-->

    <!--script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-', '');
      ga('send', 'pageview');

    </script-->
    
  </body>
</html>

